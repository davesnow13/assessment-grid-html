<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snowboard Assessment Grid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f4f6f8;
    }

    h1 {
      margin-bottom: 4px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
    }

    .controls {
      margin: 12px 0 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-size: 0.9rem;
    }

    input[type="text"] {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #0b6b2f;
      background: #0f9d3d;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }

    th, td {
      border: 2px solid #000;
      padding: 6px 4px;
      text-align: center;
      font-size: 0.85rem;
    }

    th.task-col, td.task-col {
      text-align: left;
      min-width: 210px;
      background: #f9fbfd;
    }

    th.zone-header {
      background: #e6eef7;
      text-align: left;
      font-size: 0.95rem;
    }

    th.student-group-header {
      background: #d9dde0;
    }

    th.status-header {
      background: #f3f3f3;
      font-size: 0.75rem;
    }

    .status-cell {
      background: linear-gradient(180deg, #a6f28c, #56c43b);
    }

    /* Colour coding identical to admin page */
    .status-inc {
      background-color: #ffe5e5 !important; 
      border-color: #d46a6a !important;
    }

    .status-con {
      background-color: #fff8d5 !important;
      border-color: #d6c55b !important;
    }

    .status-refi {
      background-color: #e2f6dd !important;
      border-color: #58a862 !important;
    }

    .status-inner {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #999;
      background: #e9ecef;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .status-inner.selected::after {
      content: "âœ“";
      color: #000;
      font-size: 0.8rem;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #444;
    }

    .error {
      color: #b00020;
    }

    .success {
      color: #1b5e20;
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 4px 2px;
      }
    }
  </style>
</head>
<body>
  <h1>Snowboard Assessment</h1>
  <div class="small">
    Tap a green square to set Inconsistent, Consistent, or Refined. Data is saved to Supabase automatically and also stored locally for offline work.
  </div>

  <div class="controls">
    <label>
      Group name:
      <input id="groupNameInput" type="text" placeholder="e.g. Lake Louise Group A" />
    </label>

    <label>
      Students:
      <input id="studentsInput" type="text" value="Reuben, Albert, Benedict" />
    </label>

    <button id="applyLayoutBtn">Apply layout</button>
    <button id="loadBtn">Load saved marks</button>
  </div>

  <div id="statusMsg" class="message"></div>

  <div id="tableContainer"></div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ynlzmelrlbgflcabvvfs.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlubHptZWxybGJnZmxjYWJ2dmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTYwNjYsImV4cCI6MjA3OTk5MjA2Nn0.6ylCGmMmKsShchJxsTLsLbIHwdKra0bxu4dRgs86jkE";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const STATUSES = ["Inc", "Con", "Refi"];

    const TASKS = [
      { zone: 1, label: "Load and unload a chairlift and riding the magic carpet" },
      { zone: 1, label: "Skating in a straight line" },
      { zone: 1, label: "Skate around cones" },
      { zone: 1, label: "Skate across a slope on both edges" },
      { zone: 1, label: "Switch skating in straight line" },
      { zone: 1, label: "J-turns" },

      { zone: 2, label: "Stand up on both edges" },
      { zone: 2, label: "Sideslip both edges" },
      { zone: 2, label: "Traversing on both edges" },
      { zone: 2, label: "Turning edge to edge down fall line (linked turns)" },

      { zone: 3, label: "Linked turns (continuous)" },
      { zone: 3, label: "Speed control through turn shape" },
      { zone: 3, label: "Edge release and engagement" },
      { zone: 3, label: "Flow and continuity" },
      { zone: 3, label: "Adaptability" }
    ];

    const groupNameInput = document.getElementById("groupNameInput");
    const studentsInput = document.getElementById("studentsInput");
    const tableContainer = document.getElementById("tableContainer");
    const statusMsg = document.getElementById("statusMsg");

    let currentStudents = [];

    const LOCAL_STATE_PREFIX = "assessmentGrid_state_";
    const LOCAL_QUEUE_KEY = "assessmentGrid_queue_v1";

    function parseStudents() {
      return studentsInput.value
        .split(",")
        .map(s => s.trim())
        .filter(s => s.length > 0);
    }

    function clearMessage() {
      statusMsg.textContent = "";
      statusMsg.className = "message";
    }

    function setMessage(text, isError = false) {
      statusMsg.textContent = text;
      statusMsg.className = "message " + (isError ? "error" : "success");
    }

    function localKey(student, zone, task) {
      return `${student}|${zone}|${task}`;
    }

    function loadGroupState(group) {
      try {
        const raw = localStorage.getItem(LOCAL_STATE_PREFIX + group);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveGroupState(group, state) {
      localStorage.setItem(LOCAL_STATE_PREFIX + group, JSON.stringify(state));
    }

    function updateLocalState(group, student, zone, task, status) {
      const key = localKey(student, zone, task);
      const state = loadGroupState(group);
      state[key] = status;
      saveGroupState(group, state);
    }

    function applyLocalStateToUI(group) {
      const state = loadGroupState(group);
      Object.entries(state).forEach(([key, status]) => {
        const [student, zone, task] = key.split("|");
        const s = encodeURIComponent(student);
        const t = encodeURIComponent(task);
        const selector = `.status-inner[data-student="${s}"][data-zone="${zone}"][data-task="${t}"]`;

        document.querySelectorAll(selector).forEach(el => {
          el.classList.remove("selected", "status-inc", "status-con", "status-refi");

          if (el.dataset.status === status) {
            el.classList.add("selected");

            if (status === "Inc") el.classList.add("status-inc");
            if (status === "Con") el.classList.add("status-con");
            if (status === "Refi") el.classList.add("status-refi");
          }
        });
      });
    }

    function loadQueue() {
      const raw = localStorage.getItem(LOCAL_QUEUE_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    function saveQueue(queue) {
      localStorage.setItem(LOCAL_QUEUE_KEY, JSON.stringify(queue));
    }

    function enqueueOp(op) {
      let queue = loadQueue();
      queue = queue.filter(
        q =>
          !(
            q.group_name === op.group_name &&
            q.student === op.student &&
            q.zone === op.zone &&
            q.task === op.task
          )
      );
      queue.push(op);
      saveQueue(queue);
    }

    async function trySaveToSupabase(op, isRetry = false) {
      if (!navigator.onLine) {
        enqueueOp(op);
        if (!isRetry) setMessage("Saved locally. Will sync when online.");
        return false;
      }

      try {
        await supabaseClient
          .from("evaluations")
          .delete()
          .eq("group_name", op.group_name)
          .eq("student", op.student)
          .eq("zone", op.zone)
          .eq("task", op.task);

        const { error } = await supabaseClient.from("evaluations").insert(op);
        if (error) throw error;

        if (!isRetry) setMessage("Saved.");
        return true;
      } catch (e) {
        enqueueOp(op);
        if (!isRetry) setMessage("Saved locally. Cloud error.", true);
        return false;
      }
    }

    async function processQueue() {
      if (!navigator.onLine) return;
      let queue = loadQueue();
      if (queue.length === 0) return;

      setMessage("Syncing offline changes...");
      const remaining = [];

      for (const op of queue) {
        const ok = await trySaveToSupabase(op, true);
        if (!ok) remaining.push(op);
      }

      saveQueue(remaining);

      if (remaining.length === 0) setMessage("Offline changes synced.");
      else setMessage("Some offline marks still pending.", true);
    }

    window.addEventListener("online", processQueue);

    function renderTable() {
      const group = groupNameInput.value.trim();
      if (!group) {
        setMessage("Enter a group name first.", true);
        return;
      }

      if (currentStudents.length === 0) {
        setMessage("Enter at least one student.", true);
        return;
      }

      let html = "<table>";

      html += "<tr><th class='task-col'>Task</th>";
      currentStudents.forEach(student => {
        html += `<th class="student-group-header" colspan="${STATUSES.length}">${student}</th>`;
      });
      html += "</tr>";

      html += "<tr><th></th>";
      currentStudents.forEach(() => {
        STATUSES.forEach(status => {
          html += `<th class="status-header">${status}</th>`;
        });
      });
      html += "</tr>";

      let lastZone = null;

      TASKS.forEach(task => {
        if (task.zone !== lastZone) {
          html += `<tr><th class="zone-header" colspan="${1 +
            currentStudents.length * STATUSES.length}">Zone ${task.zone}</th></tr>`;
          lastZone = task.zone;
        }

        html += `<tr><td class="task-col">${task.label}</td>`;

        currentStudents.forEach(student => {
          STATUSES.forEach(status => {
            html += `
              <td class="status-cell">
                <div class="status-inner"
                  data-student="${encodeURIComponent(student)}"
                  data-zone="${task.zone}"
                  data-task="${encodeURIComponent(task.label)}"
                  data-status="${status}">
                </div>
              </td>
            `;
          });
        });

        html += "</tr>";
      });

      html += "</table>";
      tableContainer.innerHTML = html;

      document.querySelectorAll(".status-inner").forEach(el =>
        el.addEventListener("click", onStatusClick)
      );

      applyLocalStateToUI(group);
    }

    async function onStatusClick(event) {
      const el = event.currentTarget;
      const student = decodeURIComponent(el.dataset.student);
      const zone = parseInt(el.dataset.zone);
      const task = decodeURIComponent(el.dataset.task);
      const status = el.dataset.status;
      const group = groupNameInput.value.trim();

      if (!group) return;

      const selector =
        `.status-inner[data-student="${encodeURIComponent(student)}"][data-zone="${zone}"][data-task="${encodeURIComponent(task)}"]`;

      document.querySelectorAll(selector).forEach(node => {
        node.classList.remove("selected", "status-inc", "status-con", "status-refi");
      });

      el.classList.add("selected");

      if (status === "Inc") el.classList.add("status-inc");
      if (status === "Con") el.classList.add("status-con");
      if (status === "Refi") el.classList.add("status-refi");

      updateLocalState(group, student, zone, task, status);

      const op = {
        group_name: group,
        student,
        zone,
        task,
        status
      };

      await trySaveToSupabase(op);
    }

    async function loadSavedMarks() {
      const group = groupNameInput.value.trim();
      if (!group) return;

      if (!navigator.onLine) {
        applyLocalStateToUI(group);
        setMessage("Offline. Showing local marks.");
        return;
      }

      setMessage("Loading...");
      const { data, error } = await supabaseClient
        .from("evaluations")
        .select("*")
        .eq("group_name", group);

      if (error) {
        applyLocalStateToUI(group);
        setMessage("Failed to load from cloud. Showing local marks.", true);
        return;
      }

      document.querySelectorAll(".status-inner")
        .forEach(node => node.classList.remove("selected", "status-inc", "status-con", "status-refi"));

      data.forEach(row => {
        const selector =
          `.status-inner[data-student="${encodeURIComponent(row.student)}"][data-zone="${row.zone}"][data-task="${encodeURIComponent(row.task)}"]`;

        document.querySelectorAll(selector).forEach(node => {
          if (node.dataset.status === row.status) {
            node.classList.add("selected");

            if (row.status === "Inc") node.classList.add("status-inc");
            if (row.status === "Con") node.classList.add("status-con");
            if (row.status === "Refi") node.classList.add("status-refi");
          }
        });
      });

      applyLocalStateToUI(group);

      setMessage("Loaded.");
      processQueue();
    }

    document.getElementById("applyLayoutBtn").addEventListener("click", () => {
      currentStudents = parseStudents();
      renderTable();
      clearMessage();
    });

    document.getElementById("loadBtn").addEventListener("click", () => {
      currentStudents = parseStudents();
      renderTable();
      loadSavedMarks();
    });

    currentStudents = parseStudents();
    renderTable();
    processQueue();
  </script>
</body>
</html>
