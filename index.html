<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snowboard Assessment Grid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f4f6f8;
    }

    h1 {
      margin-bottom: 4px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
    }

    .controls {
      margin: 12px 0 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-size: 0.9rem;
    }

    input[type="text"], select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #0b6b2f;
      background: #0f9d3d;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button.secondary {
      background: #5b636a;
      border-color: #4a5056;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }

    th, td {
      border: 2px solid #000;
      padding: 6px 4px;
      text-align: center;
      font-size: 0.85rem;
    }

    th.task-col, td.task-col {
      text-align: left;
      min-width: 210px;
      background: #f9fbfd;
    }

    th.zone-header {
      background: #e6eef7;
      text-align: left;
      font-size: 0.95rem;
    }

    th.student-group-header {
      background: #d9dde0;
    }

    th.status-header {
      background: #f3f3f3;
      font-size: 0.75rem;
    }

    .status-cell {
      background: linear-gradient(180deg, #a6f28c, #56c43b);
    }

    .status-inner {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #999;
      background: #e9ecef;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .status-inner.selected {
      background: #2e7d32;
      border-color: #1b5e20;
    }

    .status-inner.selected::after {
      content: "âœ“";
      color: white;
      font-size: 0.8rem;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #444;
    }

    .error {
      color: #b00020;
    }

    .success {
      color: #1b5e20;
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 4px 2px;
      }
    }
  </style>
</head>
<body>
  <h1>Snowboard Assessment</h1>
  <div class="small">
    Tap a green square to set Inc, Con or Refi. Data is saved locally first and
    synced to Supabase automatically when online. You can also export to CSV.
  </div>

  <div class="controls">
    <label>
      Group name:
      <input id="groupNameInput" type="text" placeholder="e.g. Lake Louise Group A" />
    </label>

    <label>
      Students:
      <input id="studentsInput" type="text" value="Reuben, Albert, Benedict" />
    </label>

    <button id="applyLayoutBtn">Apply layout</button>
    <button id="loadBtn">Load saved marks</button>
    <button id="exportBtn" class="secondary">Export CSV (this group)</button>
  </div>

  <div class="controls">
    <label>
      Saved groups:
      <select id="groupSelect">
        <option value="">Select a saved group</option>
      </select>
    </label>
    <button id="useGroupBtn" class="secondary">Use group</button>
  </div>

  <div id="statusMsg" class="message"></div>

  <div id="tableContainer"></div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration that works for you now
    const SUPABASE_URL = "https://ynlzmelrlbgflcabvvfs.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlubHptZWxybGJnZmxjYWJ2dmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTYwNjYsImV4cCI6MjA3OTk5MjA2Nn0.6ylCGmMmKsShchJxsTLsLbIHwdKra0bxu4dRgs86jkE";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const STATUSES = ["Inc", "Con", "Refi"];

    const TASKS = [
      { zone: 1, label: "Load and unload a chairlift and Riding the magic carpet" },
      { zone: 1, label: "Skating in a straight line" },
      { zone: 1, label: "Skate around cones" },
      { zone: 1, label: "Skate across a slope on both edges" },
      { zone: 1, label: "Switch skating in straight line" },
      { zone: 1, label: "J-turns" },

      { zone: 2, label: "Stand up on both edges" },
      { zone: 2, label: "Sideslip both edges" },
      { zone: 2, label: "Traversing on both edges" },
      { zone: 2, label: "Turning edge to edge down fall line (Linked turns)" },

      { zone: 3, label: "Linked Turns (Continuous)" },
      { zone: 3, label: "Speed Control Through Turn Shape" },
      { zone: 3, label: "Edge Release and Engagement" },
      { zone: 3, label: "Flow and Continuity" },
      { zone: 3, label: "Adaptability" }
    ];

    const groupNameInput = document.getElementById("groupNameInput");
    const studentsInput = document.getElementById("studentsInput");
    const tableContainer = document.getElementById("tableContainer");
    const statusMsg = document.getElementById("statusMsg");
    const exportBtn = document.getElementById("exportBtn");
    const groupSelect = document.getElementById("groupSelect");
    const useGroupBtn = document.getElementById("useGroupBtn");

    let currentStudents = [];

    // Local storage keys
    const LOCAL_STATE_PREFIX = "assessmentGrid_state_";   // per group
    const LOCAL_QUEUE_KEY = "assessmentGrid_queue_v1";    // offline sync queue
    const LOCAL_GROUPS_KEY = "assessmentGrid_groups";     // list of known groups

    document.getElementById("applyLayoutBtn").addEventListener("click", () => {
      currentStudents = parseStudents();
      renderTable();
      clearMessage();
      registerGroupName(groupNameInput.value.trim());
      applyLocalStateToUI(groupNameInput.value.trim());
    });

    document.getElementById("loadBtn").addEventListener("click", () => {
      currentStudents = parseStudents();
      renderTable();
      registerGroupName(groupNameInput.value.trim());
      loadSavedMarks();
    });

    exportBtn.addEventListener("click", exportCurrentGroupToCSV);

    useGroupBtn.addEventListener("click", () => {
      const selectedGroup = groupSelect.value;
      if (!selectedGroup) {
        setMessage("Select a saved group first.", true);
        return;
      }

      // Set group name field
      groupNameInput.value = selectedGroup;

      // Rebuild students list from local state for that group
      setStudentsFromLocalState(selectedGroup);

      currentStudents = parseStudents();
      renderTable();
      // Load merged local + cloud for that group
      loadSavedMarks();
    });

    function parseStudents() {
      return studentsInput.value
        .split(",")
        .map(s => s.trim())
        .filter(s => s.length > 0);
    }

    function clearMessage() {
      statusMsg.textContent = "";
      statusMsg.className = "message";
    }

    function setMessage(text, isError = false) {
      statusMsg.textContent = text;
      statusMsg.className = "message " + (isError ? "error" : "success");
    }

    // ---------- Group list helpers ----------

    function loadGroupList() {
      try {
        const raw = localStorage.getItem(LOCAL_GROUPS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveGroupList(list) {
      try {
        localStorage.setItem(LOCAL_GROUPS_KEY, JSON.stringify(list));
      } catch {
        // ignore
      }
    }

    function registerGroupName(groupName) {
      if (!groupName) return;
      const list = loadGroupList();
      if (!list.includes(groupName)) {
        list.push(groupName);
        saveGroupList(list);
        refreshGroupSelectOptions();
      }
    }

    function refreshGroupSelectOptions() {
      const list = loadGroupList().slice().sort((a, b) => a.localeCompare(b));
      // Clear existing options except first
      while (groupSelect.options.length > 1) {
        groupSelect.remove(1);
      }
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        groupSelect.appendChild(opt);
      });
    }

    function setStudentsFromLocalState(groupName) {
      const state = loadGroupState(groupName);
      const studentsSet = new Set();
      Object.keys(state).forEach(key => {
        const [student] = key.split("|");
        if (student) studentsSet.add(student);
      });
      if (studentsSet.size > 0) {
        studentsInput.value = Array.from(studentsSet).join(", ");
      }
    }

    // ---------- Local state helpers ----------

    function localKey(student, zone, task) {
      return `${student}|${zone}|${task}`;
    }

    function loadGroupState(groupName) {
      if (!groupName) return {};
      try {
        const raw = localStorage.getItem(LOCAL_STATE_PREFIX + groupName);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveGroupState(groupName, state) {
      if (!groupName) return;
      try {
        localStorage.setItem(LOCAL_STATE_PREFIX + groupName, JSON.stringify(state));
      } catch {
        // ignore
      }
    }

    function updateLocalState(groupName, student, zone, task, status) {
      if (!groupName) return;
      const key = localKey(student, zone, task);
      const state = loadGroupState(groupName);
      state[key] = status;
      saveGroupState(groupName, state);
      registerGroupName(groupName);
    }

    function applyLocalStateToUI(groupName) {
      if (!groupName) return;
      const state = loadGroupState(groupName);

      Object.entries(state).forEach(([k, status]) => {
        const [student, zone, task] = k.split("|");
        const selectorAll =
          `.status-inner[data-student="${encodeURIComponent(student)}"]` +
          `[data-zone="${zone}"][data-task="${encodeURIComponent(task)}"]`;
        const selectorOne = selectorAll + `[data-status="${status}"]`;
        const cellToSelect = document.querySelector(selectorOne);
        if (!cellToSelect) return;
        document.querySelectorAll(selectorAll).forEach(node => node.classList.remove("selected"));
        cellToSelect.classList.add("selected");
      });
    }

    // ---------- Queue helpers ----------

    function loadQueue() {
      try {
        const raw = localStorage.getItem(LOCAL_QUEUE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveQueue(queue) {
      try {
        localStorage.setItem(LOCAL_QUEUE_KEY, JSON.stringify(queue));
      } catch {
        // ignore
      }
    }

    function enqueueOp(op) {
      let queue = loadQueue();
      queue = queue.filter(
        q =>
          !(
            q.group_name === op.group_name &&
            q.student === op.student &&
            q.zone === op.zone &&
            q.task === op.task
          )
      );
      queue.push(op);
      saveQueue(queue);
      registerGroupName(op.group_name);
    }

    async function trySaveToSupabase(op, isRetry = false) {
      if (!navigator.onLine) {
        enqueueOp(op);
        if (!isRetry) setMessage("Saved locally. No network, will sync when online.");
        return false;
      }

      try {
        const { error: delError } = await supabaseClient
          .from("evaluations")
          .delete()
          .eq("group_name", op.group_name)
          .eq("student", op.student)
          .eq("zone", op.zone)
          .eq("task", op.task);

        if (delError) throw delError;

        const { error: insError } = await supabaseClient.from("evaluations").insert(op);
        if (insError) throw insError;

        if (!isRetry) setMessage("Saved.");
        return true;
      } catch (e) {
        console.error("Supabase save failed", e);
        enqueueOp(op);
        if (!isRetry) {
          const msg = e && e.message ? e.message : String(e);
          setMessage("Saved locally, cloud error: " + msg, true);
        }
        return false;
      }
    }

    async function processQueue() {
      if (!navigator.onLine) return;
      let queue = loadQueue();
      if (queue.length === 0) return;

      const remaining = [];
      setMessage("Syncing offline changes...");
      for (const op of queue) {
        const ok = await trySaveToSupabase(op, true);
        if (!ok) remaining.push(op);
      }
      saveQueue(remaining);
      if (remaining.length === 0) {
        setMessage("Offline changes synced.");
      } else {
        setMessage("Some changes still saved locally. Will retry.", true);
      }
    }

    window.addEventListener("online", processQueue);

    // ---------- Table rendering ----------

    function renderTable() {
      const groupName = groupNameInput.value.trim();

      if (!groupName) {
        setMessage("Enter a group name first.", true);
        return;
      }

      if (currentStudents.length === 0) {
        setMessage("Enter at least one student.", true);
        return;
      }

      let html = "<table>";

      html += "<tr><th class='task-col'>Task</th>";
      currentStudents.forEach(student => {
        html += `<th class="student-group-header" colspan="${STATUSES.length}">${student}</th>`;
      });
      html += "</tr>";

      html += "<tr><th></th>";
      currentStudents.forEach(() => {
        STATUSES.forEach(status => {
          html += `<th class="status-header">${status}</th>`;
        });
      });
      html += "</tr>";

      let lastZone = null;

      TASKS.forEach(task => {
        if (task.zone !== lastZone) {
          html += `<tr><th class="zone-header" colspan="${1 + currentStudents.length * STATUSES.length}">
                     Zone ${task.zone}
                   </th></tr>`;
          lastZone = task.zone;
        }

        html += `<tr><td class="task-col">${task.label}</td>`;

        currentStudents.forEach(student => {
          STATUSES.forEach(status => {
            html += `
              <td class="status-cell">
                <div class="status-inner"
                     data-student="${encodeURIComponent(student)}"
                     data-zone="${task.zone}"
                     data-task="${encodeURIComponent(task.label)}"
                     data-status="${status}">
                </div>
              </td>`;
          });
        });

        html += "</tr>";
      });

      html += "</table>";
      tableContainer.innerHTML = html;

      document.querySelectorAll(".status-inner").forEach(el => {
        el.addEventListener("click", onStatusClick);
      });
    }

    async function onStatusClick(event) {
      const el = event.currentTarget;
      const student = decodeURIComponent(el.dataset.student);
      const zone = parseInt(el.dataset.zone);
      const taskLabel = decodeURIComponent(el.dataset.task);
      const status = el.dataset.status;
      const groupName = groupNameInput.value.trim();

      if (!groupName) return;

      const selectorAll =
        `.status-inner[data-student="${encodeURIComponent(student)}"]` +
        `[data-zone="${zone}"][data-task="${encodeURIComponent(taskLabel)}"]`;

      document.querySelectorAll(selectorAll).forEach(node => node.classList.remove("selected"));
      el.classList.add("selected");

      updateLocalState(groupName, student, zone, taskLabel, status);

      const op = {
        group_name: groupName,
        student,
        zone,
        task: taskLabel,
        status
      };

      await trySaveToSupabase(op);
    }

    async function loadSavedMarks() {
      const groupName = groupNameInput.value.trim();
      if (!groupName) return;

      registerGroupName(groupName);

      if (!navigator.onLine) {
        applyLocalStateToUI(groupName);
        setMessage("Offline: showing marks stored on this device.");
        return;
      }

      setMessage("Syncing and loading from Supabase...");

      await processQueue();

      const { data, error } = await supabaseClient
        .from("evaluations")
        .select("*")
        .eq("group_name", groupName);

      if (error) {
        console.error(error);
        setMessage("Failed to load from cloud. Keeping local marks.", true);
        applyLocalStateToUI(groupName);
        return;
      }

      const localState = loadGroupState(groupName);
      const mergedState = { ...localState };

      data.forEach(row => {
        const key = localKey(row.student, row.zone, row.task);
        if (mergedState[key] == null) {
          mergedState[key] = row.status;
        }
      });

      saveGroupState(groupName, mergedState);

      document.querySelectorAll(".status-inner").forEach(node => node.classList.remove("selected"));
      applyLocalStateToUI(groupName);

      setMessage("Loaded. Local marks kept where present.");
    }

    // ---------- CSV export from localStorage ----------

    function exportCurrentGroupToCSV() {
      const groupName = groupNameInput.value.trim();
      if (!groupName) {
        setMessage("Enter a group name before exporting.", true);
        return;
      }

      const state = loadGroupState(groupName);
      const entries = Object.entries(state);
      if (entries.length === 0) {
        setMessage("No local marks found for this group to export.", true);
        return;
      }

      const headers = ["group_name", "student", "zone", "task", "status"];
      const lines = [];
      lines.push(headers.join(","));

      entries.forEach(([key, status]) => {
        const [student, zone, task] = key.split("|");

        const rowObj = {
          group_name: groupName,
          student,
          zone: zone,
          task: task,
          status: status
        };

        const values = headers.map(h => {
          let val = rowObj[h];
          if (val == null) val = "";
          val = String(val).replace(/"/g, '""');
          if (val.search(/[",\n]/) !== -1) {
            val = '"' + val + '"';
          }
          return val;
        });

        lines.push(values.join(","));
      });

      const csvContent = lines.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `snowboard_assessment_${groupName.replace(/\s+/g, "_")}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      setMessage("CSV exported from local data.");
    }

    // Initial layout
    currentStudents = parseStudents();
    renderTable();
    refreshGroupSelectOptions();
    applyLocalStateToUI(groupNameInput.value.trim());
    processQueue();
  </script>
</body>
</html>
