<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snowboard Assessment - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f4f6f8;
      margin: 0;
    }

    h1 { margin-bottom: 4px; }

    .small {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 12px;
      max-width: 1100px;
    }

    .controls {
      margin: 12px 0 16px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label { font-size: 0.95rem; font-weight: 700; }

    select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      background: #fff;
    }

    button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #0b6b2f;
      background: #0f9d3d;
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 800;
    }

    button.secondary {
      background: #5b636a;
      border-color: #4a5056;
    }

    button.danger {
      background: #c62828;
      border-color: #8e0000;
    }

    button:disabled { opacity: 0.6; cursor: default; }

    #courseStatus { font-size: 0.95rem; font-weight: 900; }
    #courseStatus.open { color: #1b5e20; }
    #courseStatus.closed { color: #c62828; }

    #statusMsg { margin-top: 6px; font-size: 0.9rem; font-weight: 800; }
    #statusMsg.error { color: #b00020; }
    #statusMsg.success { color: #1b5e20; }

    #summaryContainer { margin-top: 16px; max-width: 1100px; }

    .summary-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
    }

    .summary-title { font-size: 1.1rem; font-weight: 900; margin-bottom: 8px; }

    .summary-pass { color: #1b5e20; font-weight: 900; }
    .summary-fail { color: #c62828; font-weight: 900; }

    .summary-line { margin-top: 4px; font-size: 0.95rem; }

    #tableContainer { margin-top: 16px; overflow-x: auto; }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      min-width: 900px;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #999;
      padding: 8px 6px;
      font-size: 0.9rem;
      text-align: left;
      vertical-align: top;
      overflow-wrap: anywhere;
    }

    th { background: #e0e0e0; }

    .status-inc { background: #ffebee; }
    .status-con { background: #fffde7; }
    .status-refi { background: #e8f5e9; }

    .zone-cell { text-align: center; width: 90px; }

    .col-group { width: 210px; }
    .col-student { width: 170px; }
    .col-task { width: auto; }
    .col-status { width: 140px; }

    @media print {
      .controls, #statusMsg { display: none !important; }
      body { background: white; padding: 0; }

      /* Keep colors in print */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
  </style>
</head>
<body>
  <h1>Snowboard Assessment - Admin</h1>
  <div class="small">
    View results per group, filter by participant, close or reopen courses, and export.
    Status names use the long form: Inconsistent, Consistent, Refined.
    To pass, a participant must have at least Consistent in every zone (no Inconsistent in any zone).
  </div>

  <div class="controls">
    <label>
      Group:
      <select id="groupSelect">
        <option value="">Select a group</option>
      </select>
    </label>

    <button id="loadGroupBtn">Load group data</button>

    <label>
      Student:
      <select id="studentSelect" disabled>
        <option value="ALL">All students</option>
      </select>
    </label>

    <button id="exportCsvBtn" class="secondary" disabled>Export CSV (group)</button>
    <button id="printBtn" class="secondary" disabled>Print / PDF current student</button>
  </div>

  <div class="controls">
    <span id="courseStatus">Status: -</span>
    <button id="toggleCourseBtn" class="secondary" disabled>Close course</button>
  </div>

  <div id="statusMsg"></div>
  <div id="summaryContainer"></div>
  <div id="tableContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ynlzmelrlbgflcabvvfs.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlubHptZWxybGJnZmxjYWJ2dmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTYwNjYsImV4cCI6MjA3OTk5MjA2Nn0.6ylCGmMmKsShchJxsTLsLbIHwdKra0bxu4dRgs86jkE";

    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const groupSelect = document.getElementById("groupSelect");
    const loadGroupBtn = document.getElementById("loadGroupBtn");
    const toggleCourseBtn = document.getElementById("toggleCourseBtn");
    const courseStatusSpan = document.getElementById("courseStatus");
    const statusMsg = document.getElementById("statusMsg");
    const tableContainer = document.getElementById("tableContainer");
    const summaryContainer = document.getElementById("summaryContainer");
    const studentSelect = document.getElementById("studentSelect");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const printBtn = document.getElementById("printBtn");

    let currentGroup = null;
    let currentIsClosed = false;
    let currentData = [];
    let currentStudentFilter = "ALL";
    let participantOrder = []; // from participant_map participants[].label

    function setMessage(text, isError = false) {
      statusMsg.textContent = text;
      statusMsg.className = isError ? "error" : "success";
    }
    function clearMessage() { statusMsg.textContent = ""; statusMsg.className = ""; }

    function mapStatusLong(short) {
      if (short === "Inc") return "Inconsistent";
      if (short === "Con") return "Consistent";
      if (short === "Refi") return "Refined";
      return short;
    }
    function statusClass(short) {
      if (short === "Inc") return "status-inc";
      if (short === "Con") return "status-con";
      if (short === "Refi") return "status-refi";
      return "";
    }

    async function loadGroupList() {
      clearMessage();
      try {
        const { data: courseData, error: courseError } = await db
          .from("courses")
          .select("group_name, is_closed")
          .order("group_name", { ascending: true });

        if (courseError) throw courseError;

        while (groupSelect.options.length > 1) groupSelect.remove(1);

        (courseData || []).forEach(row => {
          if (!row.group_name) return;
          const opt = document.createElement("option");
          opt.value = row.group_name;
          opt.textContent = row.is_closed ? row.group_name + " (closed)" : row.group_name;
          groupSelect.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        setMessage("Could not load group list.", true);
      }
    }

    async function loadCourseStatus(groupName) {
      courseStatusSpan.textContent = "Status: loading...";
      courseStatusSpan.className = "";

      const { data, error } = await db
        .from("courses")
        .select("is_closed, participant_map")
        .eq("group_name", groupName)
        .maybeSingle();

      if (error && error.code !== "PGRST116") {
        console.error(error);
        courseStatusSpan.textContent = "Status: unknown";
        toggleCourseBtn.disabled = false;
        toggleCourseBtn.textContent = "Close course";
        toggleCourseBtn.className = "secondary";
        currentIsClosed = false;
        participantOrder = [];
        return;
      }

      const isClosed = data ? !!data.is_closed : false;
      currentIsClosed = isClosed;

      // participant_map ordering (if present)
      participantOrder = [];
      const pm = data?.participant_map;
      if (pm && Array.isArray(pm.participants)) {
        participantOrder = pm.participants
          .map(p => p.label)
          .filter(Boolean);
      }

      if (isClosed) {
        courseStatusSpan.textContent = "Status: Closed";
        courseStatusSpan.className = "closed";
        toggleCourseBtn.textContent = "Reopen course";
        toggleCourseBtn.className = "secondary";
      } else {
        courseStatusSpan.textContent = "Status: Open";
        courseStatusSpan.className = "open";
        toggleCourseBtn.textContent = "Close course";
        toggleCourseBtn.className = "danger";
      }
      toggleCourseBtn.disabled = false;
    }

    async function toggleCourseStatus() {
      if (!currentGroup) return;
      clearMessage();
      toggleCourseBtn.disabled = true;
      setMessage("Updating course status...");

      const newClosed = !currentIsClosed;

      const { error } = await db.from("courses").upsert(
        [{ group_name: currentGroup, is_closed: newClosed }],
        { onConflict: "group_name" }
      );

      if (error) {
        console.error(error);
        setMessage("Could not update course status.", true);
        toggleCourseBtn.disabled = false;
        return;
      }

      currentIsClosed = newClosed;
      await loadCourseStatus(currentGroup);
      await loadGroupList();

      setMessage(newClosed ? "Course closed." : "Course reopened.");
    }

    function getFilteredData() {
      if (currentStudentFilter === "ALL") return currentData;
      return currentData.filter(row => row.student === currentStudentFilter);
    }

    function renderSummary() {
      summaryContainer.innerHTML = "";
      if (currentStudentFilter === "ALL") return;

      const rows = currentData.filter(r => r.student === currentStudentFilter);
      if (!rows.length) return;

      const groupName = rows[0].group_name;
      const student = rows[0].student;

      const zoneMap = new Map();
      rows.forEach(r => {
        const z = r.zone;
        if (!zoneMap.has(z)) zoneMap.set(z, { Inc: 0, Con: 0, Refi: 0 });
        const c = zoneMap.get(z);
        if (r.status === "Inc") c.Inc++;
        else if (r.status === "Con") c.Con++;
        else if (r.status === "Refi") c.Refi++;
      });

      let overallPass = true;
      const zoneSummaries = [];

      Array.from(zoneMap.keys()).sort((a,b)=>a-b).forEach(z => {
        const c = zoneMap.get(z);
        const pass = c.Inc === 0 && (c.Con > 0 || c.Refi > 0);
        if (!pass) overallPass = false;
        zoneSummaries.push({ zone: z, counts: c, pass });
      });

      const card = document.createElement("div");
      card.className = "summary-card";

      const title = document.createElement("div");
      title.className = "summary-title";
      title.textContent = "Participant summary";
      card.appendChild(title);

      const l1 = document.createElement("div");
      l1.className = "summary-line";
      l1.innerHTML = "Group: <strong>" + groupName + "</strong>";
      card.appendChild(l1);

      const l2 = document.createElement("div");
      l2.className = "summary-line";
      l2.innerHTML = "Student: <strong>" + student + "</strong>";
      card.appendChild(l2);

      const l3 = document.createElement("div");
      l3.className = "summary-line";
      l3.innerHTML = "To pass, the participant must have minimum <strong>Consistent</strong> in all zones.";
      card.appendChild(l3);

      const l4 = document.createElement("div");
      l4.className = "summary-line " + (overallPass ? "summary-pass" : "summary-fail");
      l4.textContent = overallPass
        ? "Overall result: PASSED. Participant has at least Consistent in all zones."
        : "Overall result: NOT YET. Participant needs at least Consistent in all zones.";
      card.appendChild(l4);

      zoneSummaries.forEach(zs => {
        const ln = document.createElement("div");
        ln.className = "summary-line";
        ln.textContent = `Zone ${zs.zone}: Inc ${zs.counts.Inc}, Con ${zs.counts.Con}, Refi ${zs.counts.Refi} - ${zs.pass ? "Pass" : "Not yet"}`;
        card.appendChild(ln);
      });

      summaryContainer.appendChild(card);
    }

    function renderTable() {
      const rows = getFilteredData();

      if (!rows.length) {
        tableContainer.innerHTML = "<p>No evaluations found for this selection.</p>";
        return;
      }

      let html = "<table>";
      html += "<tr>" +
        "<th class='col-group'>Group</th>" +
        "<th class='col-student'>Student</th>" +
        "<th class='zone-cell'>Zone</th>" +
        "<th class='col-task'>Task</th>" +
        "<th class='col-status'>Status</th>" +
      "</tr>";

      rows.forEach(r => {
        const longStatus = mapStatusLong(r.status);
        const cls = statusClass(r.status);
        html += `<tr>
          <td class="col-group">${escapeHtml(r.group_name)}</td>
          <td class="col-student">${escapeHtml(r.student)}</td>
          <td class="zone-cell">Zone ${r.zone}</td>
          <td class="col-task">${escapeHtml(r.task)}</td>
          <td class="col-status ${cls}">${escapeHtml(longStatus)}</td>
        </tr>`;
      });

      html += "</table>";
      tableContainer.innerHTML = html;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    async function loadGroupData() {
      const groupName = groupSelect.value;
      if (!groupName) {
        setMessage("Select a group first.", true);
        return;
      }

      clearMessage();
      currentGroup = groupName;

      tableContainer.innerHTML = "";
      summaryContainer.innerHTML = "";
      toggleCourseBtn.disabled = true;
      studentSelect.disabled = true;
      exportCsvBtn.disabled = true;
      printBtn.disabled = true;
      studentSelect.innerHTML = '<option value="ALL">All students</option>';
      currentStudentFilter = "ALL";
      currentData = [];

      setMessage("Loading group data...");

      const { data, error } = await db
        .from("evaluations")
        .select("*")
        .eq("group_name", groupName);

      if (error) {
        console.error(error);
        setMessage("Could not load evaluations.", true);
        return;
      }

      await loadCourseStatus(groupName);

      if (!data || !data.length) {
        tableContainer.innerHTML = "<p>No evaluations found for this group.</p>";
        setMessage("Loaded, but no data for this group.");
        return;
      }

      // Sort by participant_map if we have it
      const orderIndex = new Map();
      participantOrder.forEach((name, idx) => orderIndex.set(name, idx));

      data.sort((a,b) => {
        const ai = orderIndex.has(a.student) ? orderIndex.get(a.student) : 9999;
        const bi = orderIndex.has(b.student) ? orderIndex.get(b.student) : 9999;
        if (ai !== bi) return ai - bi;
        if (a.zone !== b.zone) return a.zone - b.zone;
        return String(a.task).localeCompare(String(b.task));
      });

      currentData = data.slice();

      // Build student list in correct order
      const seen = new Set();
      const orderedStudents = [];

      // from participant_map first
      participantOrder.forEach(s => {
        if (!seen.has(s) && currentData.some(r => r.student === s)) {
          seen.add(s);
          orderedStudents.push(s);
        }
      });

      // any extras
      currentData.forEach(r => {
        if (r.student && !seen.has(r.student)) {
          seen.add(r.student);
          orderedStudents.push(r.student);
        }
      });

      orderedStudents.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        studentSelect.appendChild(opt);
      });

      studentSelect.disabled = false;
      exportCsvBtn.disabled = false;
      printBtn.disabled = (studentSelect.value === "ALL");

      renderSummary();
      renderTable();
      setMessage("Group data loaded.");
    }

    function onStudentChange() {
      currentStudentFilter = studentSelect.value;
      renderSummary();
      renderTable();
      printBtn.disabled = currentStudentFilter === "ALL" || currentData.length === 0;
    }

    function exportCsv() {
      if (!currentGroup || currentData.length === 0) {
        setMessage("No data to export.", true);
        return;
      }

      const headers = ["group_name", "student", "zone", "task", "status"];
      const lines = [headers.join(",")];

      currentData.forEach(r => {
        const row = [
          r.group_name,
          r.student,
          r.zone,
          r.task,
          mapStatusLong(r.status)
        ].map(v => {
          const s = String(v ?? "").replace(/"/g,'""');
          return (/[",\n]/.test(s)) ? `"${s}"` : s;
        });
        lines.push(row.join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `snowboard_assessment_admin_${currentGroup.replace(/\s+/g, "_")}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setMessage("CSV exported for this group.");
    }

    function printCurrent() {
      if (currentStudentFilter === "ALL") {
        setMessage("Select a student before printing.", true);
        return;
      }
      window.print();
    }

    loadGroupBtn.addEventListener("click", loadGroupData);
    toggleCourseBtn.addEventListener("click", toggleCourseStatus);
    studentSelect.addEventListener("change", onStudentChange);
    exportCsvBtn.addEventListener("click", exportCsv);
    printBtn.addEventListener("click", printCurrent);

    loadGroupList();
  </script>
</body>
</html>