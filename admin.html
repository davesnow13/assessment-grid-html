<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snowboard Assessment - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f4f6f8;
    }

    h1 {
      margin-bottom: 4px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 12px;
    }

    .controls {
      margin: 12px 0 16px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-size: 0.9rem;
    }

    select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #0b6b2f;
      background: #0f9d3d;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button.secondary {
      background: #5b636a;
      border-color: #4a5056;
    }

    button.danger {
      background: #c62828;
      border-color: #8e0000;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #courseStatus {
      font-size: 0.9rem;
    }

    #courseStatus.open {
      color: #1b5e20;
      font-weight: 600;
    }

    #courseStatus.closed {
      color: #c62828;
      font-weight: 600;
    }

    #statusMsg {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #444;
    }

    #statusMsg.error {
      color: #b00020;
    }

    #statusMsg.success {
      color: #1b5e20;
    }

    #summaryContainer {
      margin-top: 16px;
    }

    .summary-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
    }

    .summary-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .summary-pass {
      color: #1b5e20;
      font-weight: 600;
    }

    .summary-fail {
      color: #c62828;
      font-weight: 600;
    }

    .summary-line {
      margin-top: 4px;
      font-size: 0.9rem;
    }

    #tableContainer {
      margin-top: 16px;
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      min-width: 700px;
    }

    th, td {
      border: 1px solid #999;
      padding: 6px 4px;
      font-size: 0.85rem;
      text-align: left;
    }

    th {
      background: #e0e0e0;
    }

    .status-inc {
      background: #ffebee;
    }

    .status-con {
      background: #fffde7;
    }

    .status-refi {
      background: #e8f5e9;
    }

    .zone-cell {
      text-align: center;
      width: 60px;
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 4px 2px;
      }
    }

    @media print {
      .controls,
      #statusMsg {
        display: none !important;
      }
      body {
        background: white;
      }
      #summaryContainer,
      #tableContainer {
        margin-top: 0;
      }
    }
  </style>
</head>
<body>
  <h1>Snowboard Assessment - Admin</h1>
  <div class="small">
    View results per group, filter by participant, close or reopen courses, and export.
    Status names use the long form: Inconsistent, Consistent, Refined.
    To pass, a participant must have at least Consistent in every zone (no Inconsistent in any zone).
  </div>

  <div class="controls">
    <label>
      Group:
      <select id="groupSelect">
        <option value="">Select a group</option>
      </select>
    </label>

    <button id="loadGroupBtn">Load group data</button>

    <label>
      Student:
      <select id="studentSelect" disabled>
        <option value="ALL">All students</option>
      </select>
    </label>

    <button id="exportCsvBtn" class="secondary" disabled>Export CSV (group)</button>
    <button id="printBtn" class="secondary" disabled>Print / PDF current student</button>
  </div>

  <div class="controls">
    <span id="courseStatus">Status: -</span>
    <button id="toggleCourseBtn" class="secondary" disabled>Close course</button>
  </div>

  <div id="statusMsg"></div>

  <div id="summaryContainer"></div>
  <div id="tableContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase configuration (same project as index.html)
    const SUPABASE_URL = "https://ynlzmelrlbgflcabvvfs.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlubHptZWxybGJnZmxjYWJ2dmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTYwNjYsImV4cCI6MjA3OTk5MjA2Nn0.6ylCGmMmKsShchJxsTLsLbIHwdKra0bxu4dRgs86jkE";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const groupSelect = document.getElementById("groupSelect");
    const loadGroupBtn = document.getElementById("loadGroupBtn");
    const toggleCourseBtn = document.getElementById("toggleCourseBtn");
    const courseStatusSpan = document.getElementById("courseStatus");
    const statusMsg = document.getElementById("statusMsg");
    const tableContainer = document.getElementById("tableContainer");
    const summaryContainer = document.getElementById("summaryContainer");
    const studentSelect = document.getElementById("studentSelect");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const printBtn = document.getElementById("printBtn");

    let currentGroup = null;
    let currentIsClosed = false;
    let currentData = [];
    let currentStudentFilter = "ALL";

    function setMessage(text, isError = false) {
      statusMsg.textContent = text;
      statusMsg.className = isError ? "error" : "success";
    }

    function clearMessage() {
      statusMsg.textContent = "";
      statusMsg.className = "";
    }

    function mapStatusLong(short) {
      if (short === "Inc") return "Inconsistent";
      if (short === "Con") return "Consistent";
      if (short === "Refi") return "Refined";
      return short;
    }

    function statusClass(short) {
      if (short === "Inc") return "status-inc";
      if (short === "Con") return "status-con";
      if (short === "Refi") return "status-refi";
      return "";
    }

    // Updated: shows errors on-screen (not just console), and warns when 0 groups returned
    async function loadGroupList() {
      clearMessage();

      if (!navigator.onLine) {
        setMessage("Offline: cannot load group list from cloud.", true);
        return;
      }

      try {
        const [{ data: evalData, error: evalError }, { data: courseData, error: courseError }] =
          await Promise.all([
            supabase.from("evaluations").select("group_name"),
            supabase.from("courses").select("group_name, is_closed")
          ]);

        if (evalError) {
          console.error("evaluations list error:", evalError);
          setMessage("Error reading evaluations: " + (evalError.message || "unknown error"), true);
        }

        if (courseError) {
          console.error("courses list error:", courseError);
          setMessage("Error reading courses: " + (courseError.message || "unknown error"), true);
        }

        const groupsSet = new Set();
        if (evalData) {
          evalData.forEach(row => {
            if (row.group_name) groupsSet.add(row.group_name);
          });
        }
        if (courseData) {
          courseData.forEach(row => {
            if (row.group_name) groupsSet.add(row.group_name);
          });
        }

        const closedMap = new Map();
        if (courseData) {
          courseData.forEach(row => {
            closedMap.set(row.group_name, !!row.is_closed);
          });
        }

        const groups = Array.from(groupsSet).filter(Boolean).sort((a, b) => a.localeCompare(b));

        while (groupSelect.options.length > 1) {
          groupSelect.remove(1);
        }

        if (groups.length === 0) {
          setMessage(
            "No groups returned. If you know groups exist, this is usually an RLS/policy issue on courses SELECT.",
            true
          );
          return;
        }

        groups.forEach(name => {
          const opt = document.createElement("option");
          const isClosed = closedMap.get(name);
          opt.value = name;
          opt.textContent = isClosed ? name + " (closed)" : name;
          groupSelect.appendChild(opt);
        });

        setMessage("Loaded " + groups.length + " group(s).");
      } catch (e) {
        console.error("loadGroupList exception:", e);
        setMessage("Could not load group list: " + (e.message || String(e)), true);
      }
    }

    async function loadCourseStatus(groupName) {
      courseStatusSpan.textContent = "Status: loading...";
      courseStatusSpan.className = "";

      const { data, error } = await supabase
        .from("courses")
        .select("is_closed")
        .eq("group_name", groupName)
        .maybeSingle();

      // PGRST116 = "Results contain 0 rows" for maybeSingle
      if (error && error.code !== "PGRST116") {
        console.error(error);
        courseStatusSpan.textContent = "Status: unknown";
        courseStatusSpan.className = "";
        toggleCourseBtn.disabled = false;
        toggleCourseBtn.textContent = "Close course";
        toggleCourseBtn.className = "secondary";
        currentIsClosed = false;
        return;
      }

      const isClosed = data ? !!data.is_closed : false;
      currentIsClosed = isClosed;

      if (isClosed) {
        courseStatusSpan.textContent = "Status: Closed";
        courseStatusSpan.className = "closed";
        toggleCourseBtn.textContent = "Reopen course";
        toggleCourseBtn.className = "secondary";
      } else {
        courseStatusSpan.textContent = "Status: Open";
        courseStatusSpan.className = "open";
        toggleCourseBtn.textContent = "Close course";
        toggleCourseBtn.className = "danger";
      }
      toggleCourseBtn.disabled = false;
    }

    async function toggleCourseStatus() {
      if (!currentGroup) return;
      if (!navigator.onLine) {
        setMessage("Offline: cannot update course status.", true);
        return;
      }

      clearMessage();
      toggleCourseBtn.disabled = true;
      setMessage("Updating course status...");

      const newClosed = !currentIsClosed;

      const { error } = await supabase.from("courses").upsert(
        [
          {
            group_name: currentGroup,
            is_closed: newClosed
          }
        ],
        { onConflict: "group_name" }
      );

      if (error) {
        console.error(error);
        setMessage("Could not update course status: " + (error.message || "unknown error"), true);
        toggleCourseBtn.disabled = false;
        return;
      }

      currentIsClosed = newClosed;
      await loadCourseStatus(currentGroup);
      await loadGroupList(); // refresh labels

      setMessage(newClosed ? "Course closed." : "Course reopened.");
    }

    function getFilteredData() {
      if (currentStudentFilter === "ALL") return currentData;
      return currentData.filter(row => row.student === currentStudentFilter);
    }

    function renderSummary() {
      summaryContainer.innerHTML = "";

      if (currentStudentFilter === "ALL") return;

      const rows = currentData.filter(row => row.student === currentStudentFilter);
      if (rows.length === 0) return;

      const groupName = rows[0].group_name;
      const student = rows[0].student;

      const zoneMap = new Map();
      rows.forEach(row => {
        const z = row.zone;
        if (!zoneMap.has(z)) zoneMap.set(z, { Inc: 0, Con: 0, Refi: 0 });
        const counts = zoneMap.get(z);
        if (row.status === "Inc") counts.Inc += 1;
        else if (row.status === "Con") counts.Con += 1;
        else if (row.status === "Refi") counts.Refi += 1;
      });

      const zoneSummaries = [];
      let overallPass = true;

      Array.from(zoneMap.keys())
        .sort((a, b) => a - b)
        .forEach(zone => {
          const c = zoneMap.get(zone);
          const zonePass = c.Inc === 0 && (c.Con > 0 || c.Refi > 0);
          if (!zonePass) overallPass = false;
          zoneSummaries.push({ zone, counts: c, pass: zonePass });
        });

      const card = document.createElement("div");
      card.className = "summary-card";

      const title = document.createElement("div");
      title.className = "summary-title";
      title.textContent = "Participant summary";
      card.appendChild(title);

      const lineGroup = document.createElement("div");
      lineGroup.className = "summary-line";
      lineGroup.innerHTML = "Group: <strong>" + groupName + "</strong>";
      card.appendChild(lineGroup);

      const lineStudent = document.createElement("div");
      lineStudent.className = "summary-line";
      lineStudent.innerHTML = "Student: <strong>" + student + "</strong>";
      card.appendChild(lineStudent);

      const lineRule = document.createElement("div");
      lineRule.className = "summary-line";
      lineRule.innerHTML = 'To pass, the participant must have minimum <strong>Consistent</strong> in all zones.';
      card.appendChild(lineRule);

      const lineOverall = document.createElement("div");
      lineOverall.className = "summary-line " + (overallPass ? "summary-pass" : "summary-fail");
      lineOverall.innerHTML = overallPass
        ? "Overall result: PASSED. Participant has at least Consistent in all zones."
        : "Overall result: NOT YET. Participant needs at least Consistent in all zones.";
      card.appendChild(lineOverall);

      zoneSummaries.forEach(zs => {
        const l = document.createElement("div");
        l.className = "summary-line";
        const statusText = zs.pass ? "Pass" : "Not yet";
        l.textContent =
          "Zone " +
          zs.zone +
          ": Inc " +
          zs.counts.Inc +
          ", Con " +
          zs.counts.Con +
          ", Refi " +
          zs.counts.Refi +
          " - " +
          statusText;
        card.appendChild(l);
      });

      summaryContainer.appendChild(card);
    }

    function renderTable() {
      const rows = getFilteredData();

      if (!rows || rows.length === 0) {
        tableContainer.innerHTML = "<p>No evaluations found for this selection.</p>";
        return;
      }

      let html = "<table>";
      html += "<tr><th>Group</th><th>Student</th><th class='zone-cell'>Zone</th><th>Task</th><th>Status</th></tr>";

      rows.forEach(row => {
        const longStatus = mapStatusLong(row.status);
        const cls = statusClass(row.status);
        html += `<tr>
          <td>${row.group_name}</td>
          <td>${row.student}</td>
          <td class="zone-cell">Zone ${row.zone}</td>
          <td>${row.task}</td>
          <td class="${cls}">${longStatus}</td>
        </tr>`;
      });

      html += "</table>";
      tableContainer.innerHTML = html;
    }

    async function loadGroupData() {
      const groupName = groupSelect.value;
      if (!groupName) {
        setMessage("Select a group first.", true);
        return;
      }
      if (!navigator.onLine) {
        setMessage("Offline: cannot load group data from cloud.", true);
        return;
      }

      clearMessage();
      currentGroup = groupName;
      tableContainer.innerHTML = "";
      summaryContainer.innerHTML = "";
      toggleCourseBtn.disabled = true;
      studentSelect.disabled = true;
      exportCsvBtn.disabled = true;
      printBtn.disabled = true;
      studentSelect.innerHTML = '<option value="ALL">All students</option>';
      currentStudentFilter = "ALL";
      currentData = [];

      setMessage("Loading group data...");

      const { data, error } = await supabase
        .from("evaluations")
        .select("*")
        .eq("group_name", groupName)
        .order("student", { ascending: true })
        .order("zone", { ascending: true })
        .order("task", { ascending: true });

      if (error) {
        console.error(error);
        setMessage("Could not load evaluations: " + (error.message || "unknown error"), true);
        return;
      }

      await loadCourseStatus(groupName);

      if (!data || data.length === 0) {
        tableContainer.innerHTML = "<p>No evaluations found for this group.</p>";
        setMessage("Loaded, but no data for this group.");
        return;
      }

      currentData = data.slice();

      const studentsSet = new Set();
      currentData.forEach(row => {
        if (row.student) studentsSet.add(row.student);
      });
      const students = Array.from(studentsSet).sort((a, b) => a.localeCompare(b));

      students.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        studentSelect.appendChild(opt);
      });

      studentSelect.disabled = false;
      exportCsvBtn.disabled = false;
      printBtn.disabled = (studentSelect.value === "ALL");

      renderSummary();
      renderTable();

      setMessage("Group data loaded.");
    }

    function onStudentChange() {
      currentStudentFilter = studentSelect.value;
      renderSummary();
      renderTable();
      printBtn.disabled = currentStudentFilter === "ALL" || currentData.length === 0;
    }

    function exportCsv() {
      if (!currentGroup || currentData.length === 0) {
        setMessage("No data to export.", true);
        return;
      }

      const headers = ["group_name", "student", "zone", "task", "status"];
      const lines = [];
      lines.push(headers.join(","));

      currentData.forEach(row => {
        const rowObj = {
          group_name: row.group_name,
          student: row.student,
          zone: row.zone,
          task: row.task,
          status: mapStatusLong(row.status)
        };

        const values = headers.map(h => {
          let val = rowObj[h];
          if (val == null) val = "";
          val = String(val).replace(/"/g, '""');
          if (val.search(/[",\n]/) !== -1) {
            val = '"' + val + '"';
          }
          return val;
        });

        lines.push(values.join(","));
      });

      const csvContent = lines.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `snowboard_assessment_admin_${currentGroup.replace(/\s+/g, "_")}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      setMessage("CSV exported for this group.");
    }

    function printCurrent() {
      if (currentStudentFilter === "ALL") {
        setMessage("Select a student before printing.", true);
        return;
      }
      window.print();
    }

    loadGroupBtn.addEventListener("click", loadGroupData);
    toggleCourseBtn.addEventListener("click", toggleCourseStatus);
    studentSelect.addEventListener("change", onStudentChange);
    exportCsvBtn.addEventListener("click", exportCsv);
    printBtn.addEventListener("click", printCurrent);

    // Refresh group list on load and when coming back online
    loadGroupList();
    window.addEventListener("online", loadGroupList);
  </script>
</body>
</html>
