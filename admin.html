<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snowboard Assessment – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f4f6f8;
    }

    h1 {
      margin-bottom: 4px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 12px;
    }

    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #0b6b2f;
      background: #0f9d3d;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button.secondary {
      background: #5b636a;
      border-color: #4a5056;
    }

    button.danger {
      background: #c62828;
      border-color: #8e0000;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      font-size: 0.9rem;
      text-align: left;
    }

    th {
      background: #e0e4e8;
    }

    tr:nth-child(even) td {
      background: #f7f9fb;
    }

    .status-open {
      color: #1b5e20;
      font-weight: 600;
    }

    .status-closed {
      color: #b00020;
      font-weight: 600;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #444;
    }

    .error {
      color: #b00020;
    }

    .success {
      color: #1b5e20;
    }
  </style>
</head>
<body>
  <h1>Admin – Courses</h1>
  <div class="small">
    This page lets you see all groups, close or reopen courses, and open the assessment grid
    for a course to edit marks. Closing a course hides it from the saved groups list on the main page.
  </div>

  <div class="top-bar">
    <button id="refreshBtn">Refresh courses</button>
  </div>

  <div id="statusMsg" class="message"></div>

  <table>
    <thead>
      <tr>
        <th>Group name</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="coursesBody">
      <!-- Filled by JS -->
    </tbody>
  </table>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ynlzmelrlbgflcabvvfs.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlubHptZWxybGJnZmxjYWJ2dmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTYwNjYsImV4cCI6MjA3OTk5MjA2Nn0.6ylCGmMmKsShchJxsTLsLbIHwdKra0bxu4dRgs86jkE";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusMsg = document.getElementById("statusMsg");
    const coursesBody = document.getElementById("coursesBody");
    const refreshBtn = document.getElementById("refreshBtn");

    function setMessage(text, isError = false) {
      statusMsg.textContent = text;
      statusMsg.className = "message " + (isError ? "error" : "success");
    }

    refreshBtn.addEventListener("click", () => {
      loadCourses();
    });

    async function loadCourses() {
      setMessage("Loading courses...");
      coursesBody.innerHTML = "";

      try {
        // 1. Get all group names that have evaluations
        const { data: evalData, error: evalError } = await supabaseClient
          .from("evaluations")
          .select("group_name");

        if (evalError) throw evalError;

        const evalGroups = (evalData || [])
          .map(row => row.group_name)
          .filter(name => typeof name === "string" && name.trim().length > 0);

        // 2. Get course status from courses table
        const { data: coursesData, error: coursesError } = await supabaseClient
          .from("courses")
          .select("group_name,is_closed");

        if (coursesError) throw coursesError;

        const courseStatusByName = new Map();
        (coursesData || []).forEach(row => {
          if (row.group_name) {
            courseStatusByName.set(row.group_name, !!row.is_closed);
          }
        });

        // 3. Merge all group names from evaluations and courses
        const mergedSet = new Set(evalGroups);
        (coursesData || []).forEach(row => {
          if (row.group_name) mergedSet.add(row.group_name);
        });
        const mergedList = Array.from(mergedSet).sort((a, b) => a.localeCompare(b));

        if (mergedList.length === 0) {
          coursesBody.innerHTML = `
            <tr><td colspan="3">No courses found yet.</td></tr>
          `;
          setMessage("No courses found.");
          return;
        }

        // 4. Render rows
        mergedList.forEach(groupName => {
          const isClosed = courseStatusByName.get(groupName) === true;

          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = groupName;

          const tdStatus = document.createElement("td");
          tdStatus.textContent = isClosed ? "Closed" : "Open";
          tdStatus.className = isClosed ? "status-closed" : "status-open";

          const tdActions = document.createElement("td");

          const toggleBtn = document.createElement("button");
          toggleBtn.textContent = isClosed ? "Reopen course" : "Close course";
          toggleBtn.className = isClosed ? "secondary" : "danger";
          toggleBtn.addEventListener("click", () => {
            setCourseClosed(groupName, !isClosed);
          });

          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit marks";
          editBtn.style.marginLeft = "8px";
          editBtn.addEventListener("click", () => {
            openEditorForGroup(groupName);
          });

          tdActions.appendChild(toggleBtn);
          tdActions.appendChild(editBtn);

          tr.appendChild(tdName);
          tr.appendChild(tdStatus);
          tr.appendChild(tdActions);

          coursesBody.appendChild(tr);
        });

        setMessage("Courses loaded.");
      } catch (e) {
        console.error(e);
        setMessage("Failed to load courses: " + (e.message || String(e)), true);
      }
    }

    async function setCourseClosed(groupName, isClosed) {
      try {
        setMessage((isClosed ? "Closing" : "Reopening") + " course " + groupName + "...");
        const { error } = await supabaseClient
          .from("courses")
          .upsert({ group_name: groupName, is_closed: isClosed }, { onConflict: "group_name" });

        if (error) throw error;

        setMessage("Course " + groupName + " updated.");
        await loadCourses();
      } catch (e) {
        console.error(e);
        setMessage("Failed to update course: " + (e.message || String(e)), true);
      }
    }

    // Opens the main grid with the selected group preloaded
    function openEditorForGroup(groupName) {
      const url = "index.html?group=" + encodeURIComponent(groupName);
      window.open(url, "_blank");
    }

    // Initial load
    loadCourses();
  </script>
</body>
</html>
