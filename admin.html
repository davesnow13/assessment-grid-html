<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snowboard Assessment – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f4f6f8;
    }

    h1 {
      margin-bottom: 4px;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 12px;
    }

    .controls {
      margin: 12px 0 16px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-size: 0.9rem;
    }

    select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #0b6b2f;
      background: #0f9d3d;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button.secondary {
      background: #5b636a;
      border-color: #4a5056;
    }

    button.danger {
      background: #c62828;
      border-color: #8e0000;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #courseStatus {
      font-size: 0.9rem;
    }

    #courseStatus.open {
      color: #1b5e20;
      font-weight: 600;
    }

    #courseStatus.closed {
      color: #c62828;
      font-weight: 600;
    }

    #statusMsg {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #444;
    }

    #statusMsg.error {
      color: #b00020;
    }

    #statusMsg.success {
      color: #1b5e20;
    }

    #tableContainer {
      margin-top: 16px;
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      min-width: 700px;
    }

    th, td {
      border: 1px solid #999;
      padding: 6px 4px;
      font-size: 0.85rem;
      text-align: left;
    }

    th {
      background: #e0e0e0;
    }

    .status-inc {
      background: #ffebee;
    }

    .status-con {
      background: #fffde7;
    }

    .status-refi {
      background: #e8f5e9;
    }

    .zone-cell {
      text-align: center;
      width: 60px;
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.75rem;
      }
      th, td {
        padding: 4px 2px;
      }
    }
  </style>
</head>
<body>
  <h1>Snowboard Assessment – Admin</h1>
  <div class="small">
    View results per group, see course status, and close or reopen courses.
    Status names are expanded: Inc = Inconsistent, Con = Consistent, Refi = Refined.
  </div>

  <div class="controls">
    <label>
      Group:
      <select id="groupSelect">
        <option value="">Select a group</option>
      </select>
    </label>

    <button id="loadGroupBtn">Load group data</button>
  </div>

  <div class="controls">
    <span id="courseStatus">Status: –</span>
    <button id="toggleCourseBtn" class="secondary" disabled>Close course</button>
  </div>

  <div id="statusMsg"></div>

  <div id="tableContainer"></div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Same Supabase project as index.html
    const SUPABASE_URL = "https://ynlzmelrlbgflcabvvfs.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlubHptZWxybGJnZmxjYWJ2dmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MTYwNjYsImV4cCI6MjA3OTk5MjA2Nn0.6ylCGmMmKsShchJxsTLsLbIHwdKra0bxu4dRgs86jkE";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const groupSelect = document.getElementById("groupSelect");
    const loadGroupBtn = document.getElementById("loadGroupBtn");
    const toggleCourseBtn = document.getElementById("toggleCourseBtn");
    const courseStatusSpan = document.getElementById("courseStatus");
    const statusMsg = document.getElementById("statusMsg");
    const tableContainer = document.getElementById("tableContainer");

    let currentGroup = null;
    let currentIsClosed = false;

    function setMessage(text, isError = false) {
      statusMsg.textContent = text;
      statusMsg.className = isError ? "error" : "success";
    }

    function clearMessage() {
      statusMsg.textContent = "";
      statusMsg.className = "";
    }

    function mapStatusLong(short) {
      if (short === "Inc") return "Inconsistent (Inc)";
      if (short === "Con") return "Consistent (Con)";
      if (short === "Refi") return "Refined (Refi)";
      return short;
    }

    function statusClass(short) {
      if (short === "Inc") return "status-inc";
      if (short === "Con") return "status-con";
      if (short === "Refi") return "status-refi";
      return "";
    }

    async function loadGroupList() {
      clearMessage();

      try {
        const [{ data: evalData, error: evalError }, { data: courseData, error: courseError }] =
          await Promise.all([
            supabase.from("evaluations").select("group_name"),
            supabase.from("courses").select("group_name, is_closed")
          ]);

        if (evalError) {
          console.error(evalError);
        }
        if (courseError) {
          console.error(courseError);
        }

        const groupsSet = new Set();
        if (evalData) {
          evalData.forEach(row => {
            if (row.group_name) groupsSet.add(row.group_name);
          });
        }
        if (courseData) {
          courseData.forEach(row => {
            if (row.group_name) groupsSet.add(row.group_name);
          });
        }

        const closedMap = new Map();
        if (courseData) {
          courseData.forEach(row => {
            closedMap.set(row.group_name, !!row.is_closed);
          });
        }

        const groups = Array.from(groupsSet).sort((a, b) => a.localeCompare(b));

        while (groupSelect.options.length > 1) {
          groupSelect.remove(1);
        }

        groups.forEach(name => {
          const opt = document.createElement("option");
          const isClosed = closedMap.get(name);
          opt.value = name;
          opt.textContent = isClosed ? name + " (closed)" : name;
          groupSelect.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        setMessage("Could not load group list.", true);
      }
    }

    async function loadCourseStatus(groupName) {
      courseStatusSpan.textContent = "Status: loading…";
      courseStatusSpan.className = "";

      const { data, error } = await supabase
        .from("courses")
        .select("is_closed")
        .eq("group_name", groupName)
        .maybeSingle();

      if (error && error.code !== "PGRST116") {
        console.error(error);
        courseStatusSpan.textContent = "Status: unknown";
        courseStatusSpan.className = "";
        toggleCourseBtn.disabled = false;
        toggleCourseBtn.textContent = "Close course";
        toggleCourseBtn.className = "secondary";
        currentIsClosed = false;
        return;
      }

      const isClosed = data ? !!data.is_closed : false;
      currentIsClosed = isClosed;

      if (isClosed) {
        courseStatusSpan.textContent = "Status: Closed";
        courseStatusSpan.className = "closed";
        toggleCourseBtn.textContent = "Reopen course";
        toggleCourseBtn.className = "secondary";
      } else {
        courseStatusSpan.textContent = "Status: Open";
        courseStatusSpan.className = "open";
        toggleCourseBtn.textContent = "Close course";
        toggleCourseBtn.className = "danger";
      }
      toggleCourseBtn.disabled = false;
    }

    async function toggleCourseStatus() {
      if (!currentGroup) return;
      clearMessage();
      toggleCourseBtn.disabled = true;
      setMessage("Updating course status...");

      const newClosed = !currentIsClosed;

      const { error } = await supabase.from("courses").upsert(
        [
          {
            group_name: currentGroup,
            is_closed: newClosed
          }
        ],
        { onConflict: "group_name" }
      );

      if (error) {
        console.error(error);
        setMessage("Could not update course status.", true);
        toggleCourseBtn.disabled = false;
        return;
      }

      currentIsClosed = newClosed;
      await loadCourseStatus(currentGroup);
      await loadGroupList(); // refresh labels in dropdown

      setMessage(newClosed ? "Course closed." : "Course reopened.");
    }

    async function loadGroupData() {
      const groupName = groupSelect.value;
      if (!groupName) {
        setMessage("Select a group first.", true);
        return;
      }
      clearMessage();
      currentGroup = groupName;
      tableContainer.innerHTML = "";
      toggleCourseBtn.disabled = true;

      setMessage("Loading group data...");

      const { data, error } = await supabase
        .from("evaluations")
        .select("*")
        .eq("group_name", groupName)
        .order("student", { ascending: true })
        .order("zone", { ascending: true })
        .order("task", { ascending: true });

      if (error) {
        console.error(error);
        setMessage("Could not load evaluations.", true);
        return;
      }

      await loadCourseStatus(groupName);

      if (!data || data.length === 0) {
        tableContainer.innerHTML = "<p>No evaluations found for this group.</p>";
        setMessage("Loaded, but no data for this group.");
        return;
      }

      // Build a table: Student | Zone | Task | Status (long)
      let html = "<table>";
      html += "<tr><th>Student</th><th class='zone-cell'>Zone</th><th>Task</th><th>Status</th></tr>";

      data.forEach(row => {
        const longStatus = mapStatusLong(row.status);
        const cls = statusClass(row.status);
        html += `<tr>
          <td>${row.student}</td>
          <td class="zone-cell">Zone ${row.zone}</td>
          <td>${row.task}</td>
          <td class="${cls}">${longStatus}</td>
        </tr>`;
      });

      html += "</table>";
      tableContainer.innerHTML = html;

      setMessage("Group data loaded.");
    }

    loadGroupBtn.addEventListener("click", loadGroupData);
    toggleCourseBtn.addEventListener("click", toggleCourseStatus);

    loadGroupList();
  </script>
</body>
</html>
